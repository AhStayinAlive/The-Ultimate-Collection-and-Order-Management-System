<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/styles/products.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="main">
        {{>navbar}}
        {{>gridheader}}
        <div class="catalogue">
            <div class="gallery">
                {{#each products}}
                    <div class="container" data-id="{{_id}}" data-name="{{name}}" data-picture="/uploads/products/{{pictures}}">
                        <div class="product-pic-container">
                            <div class="product-actual-photo-container">
                                <img src="/uploads/products/{{pictures}}" alt="" class="product-pic">
                            </div>
                        </div>
                        <div class="product-name">
                            <p>{{name}}</p>
                            <p class="product-stock {{#stockStatus totalStock}}{{/stockStatus}}-stock">{{totalStock}} in stock</p>
                            <span class="three-dots-product-option">&nbsp;&nbsp;&#8286;</span>
                        </div>
                        <div class="product-options-popup">
                            <p><a href="" class="product-option-popup edit-product">Edit</a></p>
                            <p><a href="" class="product-option-popup delete-product">Delete</a></p>
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>    

    <div class="edit-product-modal">
        <div class="edit-product-form">
            <div class="edit-product-form-left">
                <div class="edit-main-picture">
                    <img src="/assets/upload-icon.png" name="collectionPicture" alt="" id="edit-upload-icon" accept="image/*" aria-required="true">
                    <input type="file" name="main-image" id="edit-imageInput">
                </div>
            </div>
            <div class="edit-product-form-right">
                <span class="edit-exit-form">x</span>
                <input type="text" name="" placeholder="Name" id="edit-product-name-input" class="product-detail-input" required>
                <input type="number" name="" placeholder="Price (PHP)" id="edit-product-price-input" class="product-detail-input" required>
                <input type="text" name="" placeholder="SKU" id="edit-product-sku-input" class="product-detail-input" required>
                <div class="product-material-container">
                    <div id="edit-material-list" class="material-list"></div>
                    <input type="text" id="edit-material-input" class="material-input" placeholder="Add a material and press Enter" required>
                </div>
                <button class="to-product-form2-button">Next 1/2</button>
            </div>
        </div>
    </div>


    <div class="add-product-modal">
        <div class="add-product-form">
            <div class="add-product-form-left">
                <div class="main-picture">
                    <img src="/assets/upload-icon.png" name="collectionPicture" alt="" id="upload-icon" accept="image/*" aria-required="true">
                    <input type="file" name="main-image" id="imageInput">
                </div>
            </div>
            <div class="add-product-form-right">
                <span class="exit-form">x</span>
                <input type="text" name="" placeholder="Name" id="product-name-input" class="product-detail-input" required>
                <input type="number" name="" placeholder="Price (PHP)" id="product-price-input" class="product-detail-input" required>
                <input type="text" name="" placeholder="SKU" id="product-sku-input" class="product-detail-input" required>
                <div class="product-material-container">
                    <div id="material-list" class="material-list"></div>
                    <input type="text" id="material-input" class="material-input" placeholder="Add a material and press Enter" required>
                </div>
                <button class="to-product-form2-button">Next 1/2</button>
            </div>
        </div>
    </div>

    <script>
        let tagList = [];

        $(document).ready(function(){

            $(".three-dots-product-option").click(function(event){
                event.stopPropagation(); 
                var $popup = $(this).closest('.container').find('.product-options-popup');
                $(".product-options-popup").not($popup).hide(); 
                $popup.toggle(); 
            });

            $(document).click(function(event) {
                if (!$(event.target).closest('.product-options-popup').length && !$(event.target).hasClass('three-dots-product-option')) {
                    $(".product-options-popup").hide();
                }
            });

            $(".product-options-popup").hide();

            $("#imageInput").change(function(event){
                var file = this.files[0];
                var reader = new FileReader();
                
                mediaContainer = $(".main-picture")
                reader.onload = function(e){
                    const photoContainer = document.createElement('div');
                    photoContainer.className = 'product-photo-container';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'product-photo';
                    photoContainer.appendChild(img);

                    mediaContainer.append(photoContainer);
                }
                reader.readAsDataURL(file);
            });

            $('#material-input').keydown(function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    var tag = $(this).val().trim();
                    if (tag) {
                        addTag(tag);
                        $(this).val('');
                    }
                }
            });

            $('#product-name-input').on('keyup', function() {
                const name = $(this).val();

                if (name === ""){
                    $('#product-name-input').removeClass('correct-input').addClass('wrong-input');
                } else {
                    $.ajax({
                        url: '/api/products/check-name',
                        type: 'POST',
                        data: {
                            name: name
                        },
                        success: function(data) {
                            if(data.success){
                                $('#product-name-input').removeClass('wrong-input').addClass('correct-input');
                            } else {
                                $('#product-name-input').addClass('wrong-input');
                            }
                        }
                    });
                }
            });

            $('#product-price-input').on('keyup', function() {
                if(Number($(this).val()) > 0) {
                    $('#product-price-input').removeClass('wrong-input').addClass('correct-input');
                } else {
                    $('#product-price-input').removeClass('correct-input').addClass('wrong-input');
                }
            });

            $('#product-sku-input').on('keyup', function() {
                if($(this).val() === "") {
                    $('#product-sku-input').removeClass('correct-input').addClass('wrong-input');
                } else {
                    $.ajax({
                        url: '/api/products/check-sku',
                        type: 'POST',
                        data: {
                            sku: $(this).val()
                        },
                        success: function(data) {
                            if(data.success){
                                $('#product-sku-input').removeClass('wrong-input').addClass('correct-input');
                            } else {
                                $('#product-sku-input').addClass('wrong-input');
                            }
                        }
                    });
                }
            });

            $('.add-product-modal').hide();

            $(".edit-product-modal").hide();

            $('.grid-header-add-button').on('click', function() {
                $('.add-product-modal').fadeIn();
            });

            $('.edit-product').on('click', function() {
                $('.edit-product-modal').fadeIn();
            });

            $('.exit-form').on('click', function() {
                $('.add-product-modal').fadeOut();
            });

            $('.edit-exit-form').on('click', function() {
                $('.edit-product-modal').fadeOut();
            });

            $(".main-picture").click(function(event){
                $("#imageInput").click();
            });

            $(".edit-main-picture").click(function(event){
                $("#edit-imageInput").click();
            });

            $("#imageInput").click(function(event){
                event.stopPropagation();
            });

            $("#edit-imageInput").click(function(event){
                event.stopPropagation();
            });

            function addTag(tag) {
                if (tagList.includes(tag)) {
                    console.log('Tag already exists:', tag);
                    return;
                }

                tagList.push(tag);

                var tagElement = $('<div>').addClass('material').text(tag);
                var removeButton = $('<span>').addClass('remove-material').text('Ã—').click(function() {
                    var index = tagList.indexOf(tag);
                    if (index !== -1) {
                        tagList.splice(index, 1);
                    }
                    $(this).parent().remove();
                });
                tagElement.append(removeButton);
                $('#material-list').append(tagElement);
            }

            $(".to-product-form2-button").click(function(event){
                event.preventDefault();
                const name = $('#product-name-input').val();
                const price = $('#product-price-input').val();
                const sku = $('#product-sku-input').val();
                const materials = tagList;

                if(name === "" || price === "" || sku === "" || materials.length === 0){
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Please fill out all fields!',
                    })
                    return;
                }



            });


            // delete SWAL
            $(".delete-product").click(function(event){
                event.preventDefault();
                const $container = $(this).closest('.container');
                const deleteProductId = $container.data('id');
                const productName = $container.data('name');
                const productPicture = $container.data('picture');

                Swal.fire({
                    title: 'Are you sure?',
                    html: `<p>Do you want to delete the product "<strong>${productName}</strong>"?</p><img src="${productPicture}" alt="${productName}" class="swal-product-image">`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'No, keep it'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Delete associated details?',
                            html: `<p>Do you also want to delete the associated details for "<strong>${productName}</strong>"?</p><img src="${productPicture}" alt="${productName}" class="swal-product-image">`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, delete associations',
                            cancelButtonText: 'No, keep associations'
                        }).then((assocResult) => {
                            if (assocResult.isConfirmed) {
                                $.ajax({
                                    url: '/api/products/delete/' + deleteProductId + '?deleteAssociations=true',
                                    type: 'DELETE',
                                    success: function(result) {
                                        Swal.fire(
                                            'Deleted!',
                                            `Product "<strong>${productName}</strong>" and associations have been deleted.`,
                                            'success'
                                        ).then(() => location.reload());
                                    },
                                    error: function(err) {
                                        Swal.fire('Error', 'Error deleting product.', 'error');
                                    }
                                });
                            } else if (assocResult.dismiss === Swal.DismissReason.cancel) {
                                $.ajax({
                                    url: '/api/products/delete/' + deleteProductId + '?deleteAssociations=false',
                                    type: 'DELETE',
                                    success: function(result) {
                                        Swal.fire(
                                            'Deleted!',
                                            `Product "<strong>${productName}</strong>" has been deleted, associations retained.`,
                                            'success'
                                        ).then(() => location.reload());
                                    },
                                    error: function(err) {
                                        Swal.fire('Error', 'Error deleting product.', 'error');
                                    }
                                });
                            }
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
